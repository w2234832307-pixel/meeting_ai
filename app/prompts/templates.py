"""
默认提示词模板管理
支持动态变量替换和模板继承
"""
from typing import Dict, Any

# ============================================
# 默认模板定义
# ============================================

DEFAULT_TEMPLATES = {
    "default": {
        "template_id": "default",
        "template_name": "标准会议纪要",
        "description": "适用于一般会议的标准纪要格式",
        "version": "1.0",
        "prompt_template": """你是一个专业的会议纪要助手。请仔细阅读以下会议转录文本，并生成一份完整、详实的会议纪要。

【会议转录文本】
{{ current_transcript }}

{{ history_section }}

{{ requirement_section }}

{{ mapping_section }}

【🚨 核心要求 - 必须严格遵守】
0️⃣ **用户要求（最高优先级！优先于一切）**：
   🔥🔥🔥 如果上面有【用户特别要求】部分，必须100%无条件执行！
   🔥 用户要求什么就生成什么，不要什么就完全省略什么
   🔥 用户的任何要求都是铁律，不可违背
   🔥 如果用户要求与模板、规范冲突，完全以用户要求为准
   🔥 优先级：用户要求 > 名称标准化 > 模板格式 > 其他要求

1️⃣ **名称标准化（第二优先级）**：
   ⚠️⚠️⚠️ 必须严格按照上面的【名称标准化映射表】替换所有口语化表达！
   ⚠️ 遇到任何昵称、简称、口语化称呼时，必须使用映射表中的标准名称！
   ⚠️ 例如："峰哥" 必须写成 "李峰"，"私域" 必须写成 "私域流量管理系统"
   ⚠️ 不允许在纪要中保留任何映射表中已定义的口语化表达！

2️⃣ **内容真实性**：
   ⚠️ 请直接根据上面的转录文本生成实际的会议内容，不要生成模板或占位符！
   ⚠️ 所有内容必须来自转录文本，不要使用中括号【】等占位符！
   ⚠️ 如果转录文本中有识别错误或不通顺的地方，用【存疑：原词】标记

【生成步骤】
1. **第一步：应用名称映射** - 在脑海中先将转录文本中的所有口语化表达替换为标准名称
2. 仔细阅读完整的转录文本，提取会议时间、参与人员、讨论主题
3. 总结会议的主要内容和讨论议题（使用标准名称）
4. 提炼出明确的决策事项（使用标准名称）
5. 整理出具体的行动项（任务、负责人使用标准名称、时间）

【输出格式】
## 会议基本信息
- 时间：[从转录中提取实际时间，如"2026年1月27日"，如果没有明确时间则写"未明确提及"]
- 参与人员：[列出转录中出现的所有说话人姓名，⚠️必须使用标准全名，用<strong>标签包裹，如<strong>张三</strong>、<strong>李四</strong>]
- 主题：[用一句话总结会议主题，⚠️项目名使用标准全称]

## 会议摘要
[用150字左右总结整个会议的核心内容和主要成果]

## 讨论议题
1. **[议题标题 - ⚠️使用标准项目名称]**
   [详细描述该议题的讨论内容、主要观点、⚠️参与讨论的人员必须使用标准全名]

2. **[议题标题 - ⚠️使用标准项目名称]**
   [详细描述... ⚠️所有人名必须是标准全名]

[根据转录内容继续添加其他议题]

## 决策事项
1. [具体的决策内容，如"决定采用XX方案"、"批准YY预算"等]
2. [继续列出其他决策]

## 行动项
| 任务 | 负责人 | 截止日期 |
|------|--------|---------|
| [具体任务描述，⚠️项目名用标准名称] | <strong>[负责人标准全名]</strong> | [实际日期或"未明确"] |
| [具体任务描述，⚠️项目名用标准名称] | <strong>[负责人标准全名]</strong> | [实际日期或"未明确"] |

## 后续跟进
1. [具体的跟进事项]
2. [继续列出...]

---
**纪要说明**：
- 本纪要根据会议录音转录文本整理生成
- 标记为【存疑：xxx】的内容表示识别不确定，建议人工核对
- 请各负责人按时推进行动项

🚨🚨🚨 **最后检查清单 - 生成前必须确认**：
1. ✅ 是否100%严格遵守了【用户要求】？（最高优先级！不可违背！）
   - 用户要求的任何内容是否都已执行？
   - 如果用户要求与模板冲突，是否以用户要求为准？
2. ✅ 所有人名是否已替换为【名称标准化映射表】中的标准全名？（不允许出现昵称、简称）
3. ✅ 所有项目名是否已替换为【名称标准化映射表】中的标准全称？（不允许出现口语化简称）
4. ✅ 所有公司名是否已替换为【名称标准化映射表】中的正式名称？（不允许出现俗称）
5. ✅ 是否使用了实际内容而非模板占位符？
6. ✅ 是否所有信息都来自转录文本？

⚠️⚠️⚠️ 优先级顺序：用户要求（铁律）> 名称标准化 > 模板格式 > 其他要求
⚠️ 用户要求是最高优先级，任何情况下都不可违背！
""",
        "variables": {},
        "dynamic_sections": {
            "history_section": """
【历史会议参考】
{{ history_content }}

请在生成纪要时考虑历史背景和延续性。
""",
            "requirement_section": """
🚨🚨🚨 【用户要求 - 最高优先级，不可违背】 🚨🚨🚨
{{ user_requirement }}

⚠️⚠️⚠️ **铁律**：
1. **用户的任何要求都必须100%无条件执行**
2. **用户要求的优先级高于一切（模板、规范、格式等）**
3. **如果用户要求与模板冲突，完全以用户要求为准**
4. **用户要求什么就生成什么，不要什么就完全省略什么**

🔥 不可违背，必须严格执行！
"""
        }
    },
    
    "simple": {
        "template_id": "simple",
        "template_name": "简洁版纪要",
        "description": "简洁快速的纪要格式",
        "version": "1.0",
        "prompt_template": """请用简洁的语言总结以下会议内容：

【会议转录】
{{ current_transcript }}

{{ history_section }}

{{ requirement_section }}

{{ mapping_section }}

【输出要求】
只输出以下内容（Markdown格式）：
1. 会议主题（一句话）
2. 3个关键讨论点（分点列出）
3. 决策事项（如果有）
4. 行动项（如果有）

保持简洁，总字数不超过300字。
""",
        "variables": {},
        "dynamic_sections": {
            "history_section": """
【历史会议参考】
{{ history_content }}
""",
            "requirement_section": """
🚨 【用户特别要求 - 最高优先级】 🚨
{{ user_requirement }}

⚠️ 规则：
1. 用户要求优先级 > 模板格式
2. "不要填写XXX" = 完全省略该部分
3. 如有冲突，以用户要求为准！
"""
        }
    },
    
    "detailed": {
        "template_id": "detailed",
        "template_name": "详细版纪要",
        "description": "包含完整细节的详细纪要",
        "version": "1.0",
        "prompt_template": """你是一个资深会议记录专家。请基于以下信息生成详细的会议纪要。

【当前会议转录】
{{ current_transcript }}

{{ history_section }}

{{ requirement_section }}

{{ mapping_section }}

【输出要求】
1. 会议基本信息
   - 时间、地点、参与人员、会议主题
   
2. 会议背景
   - 会议目的和背景说明
   
3. 详细讨论内容
   - 每个议题的详细讨论过程
   - 各参与人的主要观点
   - 支持和反对的理由
   
4. 决策事项
   - 明确的决策内容
   - 决策的理由和依据
   
5. 行动项
   - 具体任务、负责人、截止日期
   
6. 遗留问题
   - 未解决的问题
   - 后续需要跟进的事项

【输出格式】
使用Markdown格式，结构清晰，层次分明。
""",
        "variables": {},
        "dynamic_sections": {
            "history_section": """
【历史会议背景】
{{ history_content }}

请在纪要中体现会议的延续性和发展脉络。
""",
            "requirement_section": """
🚨 【用户特别要求 - 最高优先级】 🚨
{{ user_requirement }}

⚠️ 规则：
1. 用户要求优先级 > 模板格式
2. "不要填写XXX" = 完全省略该部分
3. 如有冲突，以用户要求为准！
"""
        }
    },
    
    "financial": {
        "template_id": "financial",
        "template_name": "财务会议纪要",
        "description": "适用于财务相关会议",
        "version": "1.0",
        "prompt_template": """你是一个财务会议记录专家。请基于以下信息生成财务会议纪要。

【当前会议转录】
{{ current_transcript }}

{{ history_section }}

{{ requirement_section }}

{{ mapping_section }}

【输出要求】
1. 会议基本信息（时间、参与人、主题）

2. 财务数据摘要
   - 提取所有涉及的金额、预算、成本等数据
   - 数据对比（同比、环比）
   
3. 财务议题讨论
   - 预算审批
   - 成本控制
   - 投资决策
   - 风险评估
   
4. 财务决策
   - 批准的预算或支出
   - 财务政策调整
   
5. 风险提示
   - 财务风险点
   - 合规性问题
   
6. 行动项
   - 财务相关的后续任务

【输出格式】
使用结构化的Markdown格式，所有金额用**加粗**标注。
""",
        "variables": {},
        "dynamic_sections": {
            "history_section": """
【历史财务数据参考】
{{ history_content }}

请在分析时对比历史数据趋势。
""",
            "requirement_section": """
🚨 【用户特别要求 - 最高优先级】 🚨
{{ user_requirement }}

⚠️ 规则：
1. 用户要求优先级 > 模板格式
2. "不要填写XXX" = 完全省略该部分
3. 如有冲突，以用户要求为准！
"""
        }
    }
}


def get_default_template(template_id: str = "default") -> Dict[str, Any]:
    """
    获取默认模板配置
    
    Args:
        template_id: 模板ID
    
    Returns:
        模板配置字典
    """
    return DEFAULT_TEMPLATES.get(template_id, DEFAULT_TEMPLATES["default"]).copy()


def list_templates() -> Dict[str, Dict[str, str]]:
    """
    列出所有可用的模板
    
    Returns:
        模板列表（ID -> {name, description}）
    """
    return {
        tid: {
            "name": tpl["template_name"],
            "description": tpl["description"],
            "version": tpl["version"]
        }
        for tid, tpl in DEFAULT_TEMPLATES.items()
    }
